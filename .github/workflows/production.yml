name: Build Release App

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: ğŸšš  Prepare System
        uses: actions/setup-node@v1
        with:
          node-version: '14.x'
      - run: sudo apt-get install libc6-dev-i386 lib32z1 -y
      - run: sudo apt-get install default-jdk -y
      - run: sudo apt-get install openjdk-8-jre-headless -y
      - run: sudo apt-get install npm -y
      - run: wget https://dl.google.com/android/repository/commandlinetools-linux-6858069_latest.zip
      - run: unzip commandlinetools-linux-6858069_latest.zip
      - run: rm commandlinetools-linux-6858069_latest.zip
      - run: mkdir $HOME/android-sdk
      - run: mv cmdline-tools $HOME/android-sdk/tools
      - run: $HOME/android-sdk/tools/bin/sdkmanager --sdk_root=$HOME/android-sdk/tools --update
      - run: yes | $HOME/android-sdk/tools/bin/sdkmanager --sdk_root=$HOME/android-sdk/tools "platforms;android-29" "build-tools;29.0.2" "extras;google;m2repository" "extras;android;m2repository"
      - run: yes | $HOME/android-sdk/tools/bin/sdkmanager --sdk_root=$HOME/android-sdk/tools --licenses
      - run: |
          echo "export ANDROID_HOME=$HOME/android-sdk
          export PATH=$PATH:$ANDROID_HOME/tools/bin
          export PATH=$PATH:$ANDROID_HOME/platform-tools
          export JAVA_OPTS='-XX:+IgnoreUnrecognizedVMOptions --add-modules java.se.ee'" > ~/.bash_profile
      - run: source ~/.bash_profile
      - run: npm i -g yarn
      - run: npm i -g cordova
      - run: npm i
      - run: keytool -genkey -dname "CN=CabitaÅŸ, OU=CabitaÅŸ YazÄ±lÄ±m, O=CabitaÅŸ YazÄ±lÄ±m, L=Ä°stanbul, S=unkown, C=TR" -keystore android.keystore -alias android -validity 10000 -keysize 2048 -storepass 123456 -keypass 123456
      - run: yarn cordova:release:full
      - uses: actions/checkout@v2
      - name: ğŸšš  Upload APK Repo
        with:
          name: apk-release
          path: android-release.apk